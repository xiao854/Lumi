# Lumi 公网发布 · 具体操作步骤

按下面顺序做，做完就能用「https://你的域名」访问 Lumi。

**若你用的是阿里云 ECS + 阿里云域名**，可直接看 **[阿里云发布步骤.md](阿里云发布步骤.md)**，里面按阿里云控制台和术语写了完整步骤。

---

## 第一步：准备一台有公网 IP 的服务器

- 买一台云服务器（阿里云、腾讯云、华为云等），或使用家里/公司有公网 IP 的电脑。
- 记下**公网 IP**（例如 `123.45.67.89`）。
- 确保能 SSH 登录：`ssh 用户名@公网IP`。

---

## 第二步：准备一个域名

- 在域名服务商（阿里云万网、腾讯云 DNSPod、GoDaddy 等）购买域名，或使用已有域名。
- 在域名控制台添加 **A 记录**：
  - **主机记录**：填 `lumi`（则访问地址为 `lumi.你的域名.com`）或填 `@`（则访问地址为 `你的域名.com`）。
  - **记录类型**：A
  - **记录值**：填第一步的**公网 IP**。
- 保存后等几分钟，在你自己电脑上执行 `ping lumi.你的域名.com`，能解析到该 IP 即可。

---

## 第三步：在服务器上安装环境和依赖

SSH 登录到服务器后执行（以 Ubuntu/Debian 为例）：

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装 Python3、pip、Nginx、Certbot
sudo apt install -y python3 python3-pip python3-venv nginx certbot python3-certbot-nginx

# 进入一个目录（如用户目录）
cd ~
# 若你已用 git 拉取过项目，则 cd 到项目目录，例如：
# cd /path/to/ZeroAssistent

# 若项目是压缩包上传的，解压后 cd 进项目根目录，然后安装 Python 依赖
pip3 install -r requirements.txt
# 若提示无权限，用：pip3 install --user -r requirements.txt
```

若你还没把 ZeroAssistent 项目放到服务器上：

- 方式 A：本机打包 `ZeroAssistent` 文件夹为 zip，用 scp 上传到服务器后解压。
- 方式 B：在服务器上 `git clone 你的仓库地址`。

---

## 第四步：配置 Nginx（用你的域名）

1. 在服务器上创建 Nginx 配置（把 `lumi.你的域名.com` 换成你第二步里用的域名）：

```bash
sudo nano /etc/nginx/sites-available/lumi
```

2. 粘贴下面内容，**只改 `server_name` 那一行的域名为你的**：

```nginx
server {
    listen 80;
    server_name lumi.你的域名.com;
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        chunked_transfer_encoding off;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
    }
}
```

3. 保存退出（Ctrl+O 回车，Ctrl+X），然后启用并重载 Nginx：

```bash
sudo ln -sf /etc/nginx/sites-available/lumi /etc/nginx/sites-enabled/
sudo nginx -t
sudo nginx -s reload
```

---

## 第五步：申请 HTTPS 证书

在服务器上执行（**域名换成你的**）：

```bash
sudo certbot --nginx -d lumi.你的域名.com
```

- 按提示输入邮箱、同意条款。
- 询问是否把 HTTP 跳转到 HTTPS 时，选 **Redirect**（推荐）。
- 完成后会自动配置好 443 和证书。

---

## 第六步：设置 Lumi 的环境变量并启动

1. 设置模型 API 密钥（至少选一种，例如 DeepSeek）：

```bash
export DEEPSEEK_API_KEY=你的DeepSeek密钥
```

2. 进入项目根目录并启动（Gunicorn 只监听本机 8000，由 Nginx 对外）：

```bash
cd /path/to/ZeroAssistent
gunicorn -w 4 -b 127.0.0.1:8000 "web_app:create_app()"
```

若希望关掉 SSH 后 Lumi 仍在运行，可用 **nohup** 或 **systemd**：

**方式 A：nohup（简单）**

```bash
cd /path/to/ZeroAssistent
export DEEPSEEK_API_KEY=你的密钥
nohup gunicorn -w 4 -b 127.0.0.1:8000 "web_app:create_app()" > lumi.log 2>&1 &
```

**方式 B：systemd（推荐，开机自启）**

```bash
sudo nano /etc/systemd/system/lumi.service
```

写入（**把「你的用户名」和「/path/to/ZeroAssistent」改成实际值**）：

```ini
[Unit]
Description=Lumi Web
After=network.target

[Service]
User=你的用户名
WorkingDirectory=/path/to/ZeroAssistent
Environment="DEEPSEEK_API_KEY=你的密钥"
ExecStart=/usr/local/bin/gunicorn -w 4 -b 127.0.0.1:8000 "web_app:create_app()"
Restart=always

[Install]
WantedBy=multi-user.target
```

若 gunicorn 不在 `/usr/local/bin/`，先执行 `which gunicorn` 看路径，把上面 `ExecStart=` 里的路径改对。然后：

```bash
sudo systemctl daemon-reload
sudo systemctl enable lumi
sudo systemctl start lumi
sudo systemctl status lumi
```

---

## 第七步：在浏览器访问

打开浏览器，访问：**https://你第二步填的域名**（例如 `https://lumi.你的域名.com`）。

若能看到 Lumi 界面，说明发布成功。若打不开，可检查：

- 服务器防火墙是否放行 80、443（云服务器要在控制台安全组里放行）。
- Nginx 是否正常：`sudo nginx -t`，`sudo systemctl status nginx`。
- Lumi 是否在跑：`curl http://127.0.0.1:8000` 或 `sudo systemctl status lumi`。

---

## 小结（你要做的事）

| 顺序 | 做什么 |
|------|--------|
| 1 | 有一台公网 IP 的服务器，能 SSH 登录 |
| 2 | 有一个域名，并做 A 记录解析到该公网 IP |
| 3 | 在服务器上安装 Python、pip、Nginx、Certbot，把 Lumi 项目放上去并 `pip install -r requirements.txt` |
| 4 | 配置 Nginx：`/etc/nginx/sites-available/lumi`，`server_name` 填你的域名，`proxy_pass` 指到 `127.0.0.1:8000`，然后 `nginx -s reload` |
| 5 | 执行 `sudo certbot --nginx -d 你的域名` 申请 HTTPS |
| 6 | 设置 `DEEPSEEK_API_KEY`（或其它 API），用 gunicorn 或 systemd 启动 Lumi，监听 `127.0.0.1:8000` |
| 7 | 浏览器访问 `https://你的域名` |

更细的说明（Docker、多 worker、日志等）见项目里的 **DEPLOY.md**。
