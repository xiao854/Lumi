# 阿里云服务器 + 阿里云域名 · 发布 Lumi 步骤

全程使用**阿里云 ECS** 和**阿里云域名**，按下面顺序做即可用 `https://你的域名` 访问 Lumi。

---

## 一、购买 / 准备阿里云 ECS 服务器

1. 登录 [阿里云控制台](https://ecs.console.aliyun.com/)。
2. 若还没有实例，点击 **创建实例**：
   - **地域**：选离你近的（如华东1）。
   - **镜像**：选 **Ubuntu 22.04**（或 20.04），便于后面用 apt 装 Nginx。
   - **实例规格**：1 核 2G 即可。
   - **网络**：选 **分配公网 IPv4**，带宽按需（如 1M）。
   - **安全组**：新建或选择已有，**务必放行**：22（SSH）、80（HTTP）、443（HTTPS）。
3. 设置 root 密码或**密钥对**（推荐密钥对登录，更安全）。若选密钥对，需先在控制台「密钥对」里创建或导入 SSH 公钥，创建实例时选择该密钥对。**如何生成 SSH 密钥对**见项目内 [密钥与密钥对说明.md](密钥与密钥对说明.md)。
4. 在实例列表里记下该实例的 **公网 IP**（例如 `47.96.xxx.xxx`）。

**已有实例时**：在 ECS 控制台 → 实例与镜像 → 实例 → 点你的实例，查看 **公网 IP**。若 80/443 打不开，到 **安全组** 里添加入方向规则：端口 80、443，授权对象 `0.0.0.0/0`。

---

## 二、在阿里云做域名解析（A 记录）

1. 登录 [阿里云域名控制台](https://dc.console.aliyun.com/)（或从阿里云首页搜「域名」）。
2. 找到你的域名，点击 **解析**（或「解析设置」）。
3. 点击 **添加记录**：
   - **记录类型**：`A`
   - **主机记录**：填 `lumi`（访问地址为 `lumi.你的域名.com`）或填 `@`（访问地址为 `你的域名.com`）。
   - **记录值**：填 **一、里记下的 ECS 公网 IP**。
   - **TTL**：默认 10 分钟即可。
4. 保存。等几分钟后，在你本机执行 `ping lumi.你的域名.com`，能解析到该 IP 即可。

---

## 三、SSH 登录 ECS 并安装环境

1. 在本机终端用 SSH 登录（把 `你的公网IP` 换成实际 IP，Windows 可用 PowerShell 或 Git Bash）：

```bash
ssh root@你的公网IP
```

2. 登录成功后，在 ECS 上执行：

```bash
apt update && apt install -y python3 python3-pip python3-venv nginx certbot python3-certbot-nginx
```

---

## 四、把 Lumi 项目放到服务器上

任选一种方式。

**方式 A：本机打包上传**

- 在你**本机**把整个 `ZeroAssistent` 文件夹打成 zip。
- 用 scp 上传（在**本机**执行，路径按你本机实际改）：

```bash
scp ZeroAssistent.zip root@你的公网IP:/root/
```

- 在 **ECS 上**解压并进入目录：

```bash
cd /root
apt install -y unzip
unzip ZeroAssistent.zip
cd ZeroAssistent
pip3 install -r requirements.txt
```

**方式 B：在 ECS 上 git clone（若代码在 Git 仓库）**

```bash
cd /root
apt install -y git
git clone 你的仓库地址
cd ZeroAssistent
pip3 install -r requirements.txt
```

---

## 五、配置 Nginx（域名填你在二里用的）

在 ECS 上执行：

```bash
nano /etc/nginx/sites-available/lumi
```

粘贴下面内容，**只把 `lumi.你的域名.com` 改成你在第二步填的主机记录对应的域名**（例如若主机记录是 `lumi` 且域名是 `example.com`，就写 `lumi.example.com`）：

```nginx
server {
    listen 80;
    server_name lumi.你的域名.com;
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        chunked_transfer_encoding off;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
    }
}
```

保存退出后执行：

```bash
ln -sf /etc/nginx/sites-available/lumi /etc/nginx/sites-enabled/
nginx -t
nginx -s reload
```

---

## 六、申请 HTTPS 证书（Let's Encrypt）

在 ECS 上执行（**域名改成你的**）：

```bash
certbot --nginx -d lumi.你的域名.com
```

按提示输入邮箱、同意条款；询问是否将 HTTP 重定向到 HTTPS 时选 **Redirect**。完成后会自动配置好 443。

---

## 七、设置 API 密钥并启动 Lumi

1. 设置环境变量（至少配置一种模型，例如 DeepSeek）：

```bash
export DEEPSEEK_API_KEY=你的DeepSeek密钥
```

2. 进入项目目录并用 Gunicorn 启动（**路径改成你实际放项目的路径**）：

```bash
cd /root/ZeroAssistent
gunicorn -w 4 -b 127.0.0.1:8000 "web_app:create_app()"
```

关掉 SSH 后进程会停。若希望**一直运行、掉线自启**，用 systemd（推荐）：

```bash
nano /etc/systemd/system/lumi.service
```

写入（**把 `/root/ZeroAssistent` 改成你实际项目路径，`你的密钥` 改成真实密钥**）：

```ini
[Unit]
Description=Lumi Web
After=network.target

[Service]
User=root
WorkingDirectory=/root/ZeroAssistent
Environment="DEEPSEEK_API_KEY=你的密钥"
ExecStart=/usr/local/bin/gunicorn -w 4 -b 127.0.0.1:8000 "web_app:create_app()"
Restart=always

[Install]
WantedBy=multi-user.target
```

若 `which gunicorn` 显示的路径不是 `/usr/local/bin/gunicorn`，把上面 `ExecStart=` 里的路径改成 `which gunicorn` 的结果。然后执行：

```bash
systemctl daemon-reload
systemctl enable lumi
systemctl start lumi
systemctl status lumi
```

---

## 八、浏览器访问

在浏览器打开：**https://你第二步里用的域名**（例如 `https://lumi.你的域名.com`）。

能打开 Lumi 页面即表示发布成功。

若打不开，可检查：

- **阿里云安全组**：入方向是否放行 80、443。
- **Nginx**：`nginx -t`，`systemctl status nginx`。
- **Lumi**：`systemctl status lumi` 或 `curl http://127.0.0.1:8000`。

---

## 小结（阿里云版）

| 步骤 | 在哪里做 | 做什么 |
|------|----------|--------|
| 1 | 阿里云 ECS 控制台 | 创建/准备实例，记下公网 IP，安全组放行 22、80、443 |
| 2 | 阿里云域名控制台 | 添加 A 记录，主机记录 lumi（或 @），记录值 = 公网 IP |
| 3 | ECS 上 SSH | 安装 python3、pip、nginx、certbot |
| 4 | ECS 上 | 上传或 clone 项目，`pip3 install -r requirements.txt` |
| 5 | ECS 上 | 配置 Nginx，`server_name` 填你的域名，重载 nginx |
| 6 | ECS 上 | `certbot --nginx -d 你的域名` 申请 HTTPS |
| 7 | ECS 上 | 设置 DEEPSEEK_API_KEY，用 gunicorn 或 systemd 启动 Lumi |
| 8 | 本机浏览器 | 访问 https://你的域名 |

更多细节（Docker、多 worker 等）见项目内 **DEPLOY.md**。
